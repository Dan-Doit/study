## CQRS

Command Query Responsiblity Segregation 패턴의 약자이다.

CQRS는 시스템의 데이터를 관리하는 방식을 조금 다르게 가져간다.



### 배경

먼저 우리가 흔히 사용하는 데이터베이스는 그의 목적성에 맞게 장점과 단점이 두드러 진다.

저장의 목적이 있는 DB가 있을수 있고, 읽는 것이 목적인 DB가 있을것이다.

어느하나 특정지어 사용하기에는 변동되는 비지니스에 완벽하게 대응하는 DB는 존재하지 않기 때문에 이런 패턴을 사용하게된다.

CQRS 패턴은 모델들을 물리적 데이터베이스에 머터리얼라이즈 해서 유연한 질의에 사용할 수 있게 해준다.

> 머터리얼라이즈 (materialize)
>
> *빈번한 질의의 결과를 물리 테이블에 저장해 성능을 높이는 매커니즘*

이는 또한 이벤트 소싱(Event Sourcing) 패턴과 좋은 시너지 효과를 발휘한다.



### OLPT 와 OLAP

먼저 여기 시스템 데이터 베이스의 속성이 있다.

두가지를 비교한 표는 다음과 같다.

|            | OLTP 시스템                                                  | OLAP 시스템                                                  |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 약어       | online transaction processing                                | online analytical processing                                 |
| 목적       | 다수의 사용자에 의한 대량의 데이터베이스 트랜잭션을 실시간으로 실행할 수 있도록 지원 | 일반적으로 분석을 목적으로 데이터베이스 내 다수의 레코드에 대한 질의 작업을 지원 |
| 속도       | 빛의 속도에 가까운 빠른 응답시간 필요                        | OLPT에 대비 엄청나게 느린 응답시간 필요                      |
| 작업       | 적은 양의 데이터를 자주 수정하거나, 읽기 및 쓰기 작업간 균형이 유지되는 작업 | 데이터를 전혀 수정하지 않고, 읽기에 특화되어있는 작업        |
| 저장  방법 | 인덱스화된 데이터를 사용해 응답 시간을 개선                  | 대량의 레코드에 쉽게 액세스 할수 있도록 컬럼 형식으로 데이터 저장 |
| 공간       | 상대적으로 적은 스토리지 공간 필요                           | 상당한 양의 스토리지 공간 필요                               |
| 복잡도     | 일반적으로 하나 또는 몇개의 레코드를 포함하는 간순한 쿼리    | 다수의 레코드를 포함하는 복잡한 쿼리                         |

둘의 차이는 매우 명확한데 바로 '읽기에 얼마나 더 특화되어있느냐'라고 볼수있다.



### 적합성

CQRS는 위와같은 데이터베이스의 속성을 고려할 수 있고 또는 다른 데이터 베이스간의 목적성에 맞는 분리가 될수도 있다.

시스템 모델이 담당하는 책임은 타입에 따라 분리가 될것이다.

이 패턴에서는 때에따라 생성, 수정, 삭제와 읽기를 다른 데이터 베이스로 분리할수 있을것이다.

커맨드는 강한 일관성을 가진 커맨드 실행 모델에서만 동작할 것이고

질의는 읽기 모델과 커맨드 실행 모델을 포함하여 그 어떤 시스템의 영속 상태를 직접 수정할수 없을것이다.



### CQRS가 사용되야 하는 상황

- 다양한 종류의 데이터베이스에 저장된 동일한 데이터와 작동할 필요가 있는 애플리케이션에 유용하다.
- 커맨드 실행에 모델을 저장하기 위한 관계형 데이터베이스, 전문 검색을 위한 검색 인덱스, 빠른 데이터 검색을 위한 사전 렌더링된 플랫 파일등을 구성할때 유용하다.
- 이벤트 소싱 도메인 모델을 적용할때 유용하다.