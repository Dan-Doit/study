## 프록시

웹 프록시 서버는 클라이언트 입장에서 트랜잭션을 수행하는 중개인이다.

웹 프록시가 없다면, 클라이언트는 HTTP 서버와 직접 이야기한다.

웹 프록시가 있다면, 클라이언트는 자신의 입장에서 서버와 대화해주는 프록시와 이야기한다.





### 개인 프록시와 공유 프록시

프록시 서버는 하나의 클라이언트가 독점적으로 사용할수도 있고, 여러 클라이언트가 공유할 수도 있다.

- 공용 프록시

  대부분의 프록시는 공용이며 공유된 프록시다.

  중앙 집중형 프록시를 관리하는 게 더 비용 효율이 높고 쉽다.

  캐시 프록시 서버의 경우 이용자가 많을수록 공통된 요청에서 이득을 취할수 있다.

- 개인 프록시

  클라이언트 컴퓨터에서 직접 실행되는 형태로 흔하지는 않지만 꾸준히 사용되고 있다.

  브라우저 보조 제품들은 기능을 확장하거나 서비스를 위한 광고를 운영하기 위해 작은 프록시를 사용자의 컴퓨터에서 실행합니다.



### 프록시 VS 게이트웨이

엄밀하게 말하면, 프록시는 **같은 프로토콜을 사용하는 둘 이상의 애플리케이션**을 연결하고, 

게이트웨이는 **서로 다른 프로토콜**을 사용하는 둘 이상을 연결한다.

하지만 실질적으로 프록시와 게이트웨이의 차이점은 모호하다.

브라우저와 서버는 다른버전의 HTTP를 구현하기 때문에, 프록시는 때때로 프로토콜의 변환을 하기도 한다.

상용 프록시 서버는 SSL 보안 프로토콜, SOCKS 방화벽, FTP 접근, 웹 기반 애플리케이션을 지원하기위해 게이트웨이 기능을 구현한다.



### 프록시를 사용하는 이유

프록시는 실용적이고 유용한 것이라면 무슨 일이든 한다.

보안개선, 성능 새견, 비용절약 등등

프록시 서버는 모든 HTTP 트래픽을 들여다보고 건드릴 수 있기 때문에, 부가적인 가치를 주는 여러 유용한 웹 서비스를 구현하기위해 트래픽을 감시하고 수정한다.

실제로 사용되는 예제를 보자.

- 어린이 필터

  초등학교 어린이들에게 성인 콘텐츠를 차단하기위해 필터링 프록시를 사용할 수 있다.

- 문저 접근 제어자

  많은 웹 서버들과 웹 리소스에 대한 단일한 접근 제어 전략을 구현 감시 추적하기위해 사용 될 수 있다.

  각기 다른 조직에서 관리되는 다양한 종류의 웹 서버들에 대한 접근제어를 중앙 프록시 서버에서 제어할수 있다.

- 보안 방화벽

  네트워크 보안 엔지니어는 종종 보안을 강화하기 위해 프록시 서버를 사용한다.

  바이러스를 제거하는 웹이나 이메일 프록시가 사용할수 있는, 트래픽을 세심하게 살펴볼수 있는 후크를 제공한다.

- 웹 캐시

  프록시 캐시는 인기 있는 문서의 로컬 사본을 관리하고 해당 문서에 대한 요청이 오면 빠르게 제공하여, 느리고 비싼 인터넷 커뮤니케이션을 줄인다.

- 리버스 프록시

  어떤 프록시들은 웹 서버인것 처럼 위장한다.

  그렇기 때문에 '대리 프록시' 또는 '리버스 프록시'라고 불리는 이들은 진짜 웹서버 요청을 받지만

  웹 서버와는 달리 요청받은 콘텐츠의 위치를 찾기위해 다른 서버와 커뮤니케이션을 한다.

- 콘텐츠 라우터

  프록시 서버는 인터넷 트래픽 조건과 콘텐츠의 종류에 따라 요청을 특정 웹 서버로 유도하는 콘텐츠 라우터로 동작할 수 있다.

- 트랜스코더

  프록시 서버는 콘텐츠를 전송을 위해 본문 포맷을 수정할수 있습니다.

  예를 들어 자신을 거쳐가는 GIF파일을 JPG 이미지로 변환할 수 있습니다.

- 익명화 프록시

  프록시 서버는 HTTP 메시지에서 신원을 식별할수 있는 특성들

  IP 주소, From 헤더, Referer헤더, 쿠키, URL 세션 아이디를 적극적으로 제거함으로써 개인 정보 보호와 익명성 보장에 기여합니다.



### 프록시 서버의 위치

- [포워드 프록시](###포워드 프록시)

  로컬 네트워크와 더 큰 인터넷 사이를 오가는 트래픽을 제어라기 위해 프록시를 로컬 네트워크 출구에 넣을수 있다.

  회사 밖의 악의적인 헤커들을 막는 방화벽제공, 인터넷 요금 절약 트래픽 성능 향상을 위한 출구 프록시이다.

  초등학교에서는 부적절한 콘텐츠 브라우징 차단을위해 사용된다.

- 접근 프록시

  고객으로부터 모든 요청을 종합적으로 처리하기 위한 프록시이며 [ISP](###ISP(Internet Service Provider)) 접근 지점에 위치한다.

  이 프록시는 사용자들의 다운로드 속도를 개선하고 인터넷 대역폭 비용을 줄이기 위해 캐시 프록시등을 사용한다.

- [리버스 프록시](###리버스 프록시)

  네트워크의 가장끝에 있는 웹서버의 앞에 위치하고 있다.

  서버로 향하는 모든 요청을 처리하고 필요할때만 서버에 요청할 수 있다.

  또한 웹 서버의 보안기능이나 성능개선을 할 수 있다.

- 네트워크 교환 프록시

  네크워크 사이 인터넷 피어링 교환지점에 위치하고 있다.

  캐시를 이용한 인터넷 교차로의 혼잡을 완화하고 트래픽 흐름을 감시하기 위해 사용된다.



### 프록시 계층

프록시 서버 사이에는 부모자식 관계를 갖는다.

다음번 인바운드 프록시(서버쪽)를 부모라고 부르고  다음번 아웃바운드 프록시를 자식(클라이언트쪽)이라고 부른다.



### 프록시의 트래픽 처리

- 클라이언트 수정
- 네트워크 수정
- DNS 이름공간 수정
- 웹서버 수정



### 클라이언트 프록시 설정

- 수동

  많은 웹 클라이언트에서 수동으로 설정하도록 구성되어있다.

  크롬, 익스플로러등 환경설정에서 쉽게 프록시 설정을 할수 있다.

- PAC 파일

  수동 프록시는 단순하지만 유연하지 못하다.

  모든 콘텐츠에 단 하나의 프록시만 설정하디에 장애시의 대체 작동에 대한 지원도 없다.

  프록시 자동 설정(PAC) 파일은 프록시 수동 설정보다 동적인 해결책인데, 작은 자바스크립트 프로그램이기 때문이다.

- WPAD

  웹 프록시 자동발견 프로토콜(WPAD)은 여러 발견 메커니즘들의 상승 전략을 이용해 브라우저에게 알맞은 PAC 파일을 자동으로 찾아주는 알고리즘이다.



### 프록시 요청의 미묘한 특징들

- 프록시 URI는 서버 URI와 다르다.

  프록시가 부상하면서, 부분 URI가 문제가 되었다. 프록시는 목적지 서버와 커넥션을 맺어야 하기 때문에, 그 서버의 이름을 알 필요가있다. 

- 가상 호스팅에서 일어나는 같은 문제

  프록시의 '스키마/호스트/포트번호 누락' 문제는 가상으로 호슽팅 되는 웹 서버가 직면한 것과 같은 문제다.

- 인터셉트 프록시는 부분 URI를 받는다

- 프록시는 프록시 요청과 서버 요청을 모두 다룰수 있다

  트래픽이 프록시 서버로 리다이렉트 될 수 있는 여러 가지 방법이 존재하기 때문에, 다목적 프록시 서버는 요청 메시지의 완전한 URI와 부분 URI를 모두 지원해야한다.

- 전송 중 URI 변경

- URI 클라이언트 자동확장과 호스트 명 분석

  브라우저에서는 프록시의 존재 여부에 따라 요청 URI를 다르게 분석한다.

  프록시가 없다면 사용자가 타이핑한 URI를 가지고 그에 대응하는 IP주소를 찾는다.

  만약 호스트명이 발견되면 그에 대응하는 IP주소들을 연결헤 성공할때 까지 시도한다.

  

### 프록시가 없는 URI 분석

프록시가 없는 URI에 대해 브라우저는 자동확장을 한다.

여러 가능성들을 검색하는 것이다.

다음의 순서로 진행이된다.

- 사용자가 'asdasd' 를 주소창에 입력한다.
- 브라우저는 DNS를 통해 호스트 'asdasd'를 찾는다.
- 실패하였다! 호스트를 알수 없다.
- 브라우저는 'www.asdasd.com'으로 자동확장한다.
- 브라우저는  DNS를 통해 호스트 'www.asdasd.com'을 찾는다.
- 성공하였다! IP 주소를 돌려준다.
- 브라우저는 IP 주소들에 대해 성공할 때까지 하나씩 접속을 시도한다.
- 성공했다! 커넥션을 맺는다.
- 브라우저는 HTTP 요청을 보낸다.
- 브라우저는 HTTP 응답을 받는다.



### 명시적인 프록시의 URI 분석

만약 명시적인 프록시가 있다면 브라우저는 편리한 확장들중 어느것도 더 이상 수행할 수 없다.

브라우저의 URI가 프락시를 그냥 지나쳐버리기 때문이다.

하지만 몇몇 프록시는 www...com 자동확장이나 지역 도메인 접미사 추가와 같은것들을 흉내내려 시도한다.

다음의 순서로 진행이된다.

- 사용자가 'asdasd' 를 주소창에 입력한다.
- 프록시가 명시적으로 설정되었으므로, 브라우저는 DNS를 사용해 프록시 서버를 찾는다.
- 성공했다! 프록시 서버 IP주소를 얻었다.
- 브라우저는 프록시에 접속 시도를한다.
- 성공했다! 커넥션을 맺는다.
- 브라우저는 HTTP 요청을 보낸다.
- 클라이언트가 자동확장을 하지 않았기 때문에, 프록시는 요청부분 호스트 명을 얻는다.



### 인터셉트 프록시의 URI 분석

호스트 명 분석은 보이지 않는 인터셉트 프록시와 함께일 때 약간 달라진다.

왜냐하면 클라이언트 입장에서 프록시는 존재하지 않는 것이기 때문이다.



### 메시지 추적

오늘날 웹 요청이 클라이언트에서 서버로 향하는 도중에 둘 이상의 프록시를 지나게 되는것은 드문일이 아니다.

비용절담을 위해 캐시프록시를 사용할수도 있으며, 많은 대형 ISP들이 성능개선 기능개선을 위해 사용하고있다.

그렇기 때문에 스위치나 라우터를 넘나드는 IP패킷을 추적하는것 못지 않게 프록시 추적도 필요한 일이되었다.

- Via 헤더

  이 헤더 필드는 메시지가 지나는 프록시나 게이트웨이(중간 노드)의 정보를 나열한다.

  메시지가 또 다른 중간 노드를 지날때 via 목록의 끝에 반드시 추가되어야한다.

  ```http
  GET /index.html HTTP/1.0
  Accept: test/html
  Host: www.joes-hardware.com
  Via: 1.1 proxy-62.irenes.isp.net, 1.0 cache,joes-hardware.com
  ```



### TRACE 메서드

프록시는 메시지가 전달될 때 메시지를 바꿀 수 있다.

헤더가 추가되거나, 변경되거나, 삭제될수 있으며 본문이 다른 형식으로 변환될 수 있다.

이때 TRACE 메서드는 프록시의 흐름을 디버깅하는데 매우 유용하다.

- Max-Forwards

  일반적으로 TRACE 메시지는 중간에 프록시들이 몇개나 있는지 신경쓰지 않는다.

  하지만 Max-Forwards 헤더를 이용하여 이를 제한할수 있다.

  이 옵션은 메시지 무한 루프나, 특정 프록시의ㅡ효과를 페크할때 유용하다.



### OPTIONS 메서드

HTTP OPTIONS 메서드는 서버나 웹 서버의 특정 리소스가 어떤 기능을 지원하는지 알아볼수 있게 해준다.

서로 다른 기능 수준의 서버와 프록시가 더 쉽게 상호작용할 수 있도록 클라이언트는 OPTIONS를 이용해 서버의 능력을 먼저 알아낼수 있다.

```http
OPTIONS * HTTP/1.1
// 만약 OPTIONS의 다음값이 * 서버 전체 능력에 대해 묻는것이다.
```

```http
OPTIONS http://www.joe.com/index.html HTTP/1.1
// 만약 OPTIONS의 다음값이 URL이면 특정 리소스에 대해 가능한 기능을 묻는 것이다.
// static HTML file wouldn't accept a POST method.
```

- Allow 헤더

  Allow 헤더는 요청 URI에 의해 식별되는 자원에 대해 지원되는 메서드들이나 서버가 지원하는 모든 메서드를 열거한다.

  ```http
  Allow: GET, HEAD, POST
  ```

  서버는 실제로 지원하는 메서드들을 Allow 해더에 포함해야한다.





## 더 자세히 알기

### ISP(Internet Service Provider)

흔히 '인터넷 회사' 라고 불리는 업체들은 인터넷 서비스를 제공하고 ISP 라고 불리웁니다.

우리나라의 경우에는 KT, LGU+, SK브로드 밴드등이 대표적인 기업입니다.



### 포워드 프록시

우선 정부, 학교, 기업 등과 같은 기관은 해당 기관에 속한 사람들의 제한적인 인터넷 사용을 위해 방화벽을 사용합니다. 포워드 프록시 서버는 이런 제한을 위해 사용합니다. 즉, 해당 기관에 속한 사람들이 그들이 방문하고자 하는 웹사이트에 직접적으로(directly) 방문하는 것을 방지합니다.

이 말은 곧 포워드 프록시 서버는 기관에 속한 유저가 특정 컨텐츠에 접근하는 것을 방지하는데 사용된다는 말과 동일합니다. 예를 들어, 포워드 프록시 서버에 룰을 추가해서 특정 사이트에 접속하는 것을 막을 수 있습니다.

마지막으로 포워드 프록시 서버를 사용하면 유저의 정체를 숨겨줍니다. 인터넷을 사용하는 대부분 유저들은 익명성을 바라는데 프록시 서버를 사용하지 않으면 자신의 정체가 탄로 날 수 있습니다. 하지만 만약 포워드 프록시 서버를 사용하면 IP 주소를 역추적해도 정체를 파악하기 어렵습니다. 왜냐면 IP 추적해도 프록시 서버만 보이기 때문입니다.



### 리버스 프록시

우선 리버스 프록시 서버는 로드 밸런싱(load balancing)에 사용됩니다. 트래픽이 많은 사이트 일수록 대량의 트래픽을 하나의 싱글 서버로 감당해 내기란 어렵습니다. 하지만 리버스 프록시 서버를 여러개의 서버 앞에 두면 특정 서버가 과부화 되지 않게 로드밸런싱이 가능합니다.

또한 리버스 프록시를 사용하면 보안에 좋습니다. 리버스 프록시를 사용하면 본래 서버의 IP 주소를 노출시킬 필요가 없습니다. 따라서 해커들의 DDoS 공격과 같은 공격을 막는데 유용합니다. 대신 CDN과 같은 리버스 프록시 서버가 공격의 타겟이 될수는 있습니다.

그리고 리버스 프록시 서버에는 성능 향상을 위해 캐시 데이터를 저장할 수 있습니다. 만약 어떤 한국에 있는 유저가 미국에 웹서버를 두고 있는 사이트에 접속할때, 리버스 프록시 서버가 한국에 있다고 해봅시다. 그러면 한국에 있는 유저는 한국에 있는 리버스 프록시 서버와 통신합니다. 따라서 리버스 프록시 서버에 캐싱되어 있는 데이터를 사용할 경우에는 더 빠른 성능을 보여줄수 있는 것입니다.

마지막으로 SSL 암호화에 좋습니다. 본래 서버가 클라이언트들과 통신을 할때 SSL(or TSL)로 암호화, 복호화를 할 경우 비용이 많이 듭니다. 그러나 리버스 프록시를 사용하면 들어오는 요청을 모두 복호화하고 나가는 응답을 암호화해주므로 클라이언트와 안전한 통신을 할수 있으며 본래 서버의 부담을 줄여줍니다.

[참조 블로그](https://losskatsu.github.io/it-infra/reverse-proxy/#3-%EB%A6%AC%EB%B2%84%EC%8A%A4-%ED%94%84%EB%A1%9D%EC%8B%9Creverse-proxy-%EC%84%9C%EB%B2%84%EB%9E%80)